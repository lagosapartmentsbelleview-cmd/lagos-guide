<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Painel de Limpeza</title>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Configura√ß√£o Firebase -->
    <script src="js/firebase-config.js"></script>

    <!-- Verificar login -->
    <script>
        firebase.auth().onAuthStateChanged(user => {
            if (!user) window.location.href = "login.html";
        });
    </script>

    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/limpeza.css">
</head>

<body>

    <div class="top-menu">
    <div class="menu-button" onclick="toggleMenu()">‚ò∞ Menu</div>

   <div class="dropdown-menu" id="dropdown-menu">
            <a href="listagem-reservas.html">Reservas</a>
            <a href="calendario.html">Limpeza</a>
            <a href="limpeza.html">Pre√ßos</a>
            <a href="precos.html">Calend√°rio</a>
            <a href="logout.html" class="sair">Sair</a>
        </div>
</div>

    <div class="content">
        <h1>Painel de Limpeza</h1>


     <div class="filtros">
    <label for="dataInicio">In√≠cio:</label>
    <input type="date" id="dataInicio">

    <label for="dataFim">Fim:</label>
    <input type="date" id="dataFim">

    <button id="btnGerar">Gerar</button>
</div>


    </header>

    <!-- PAINEL ADMIN -->
    <section id="painelAdmin" class="painel-admin fechado">
        <div class="painel-admin-header">
            <span id="toggleAdmin">‚ñ∂</span>
            <h2>Administra√ß√£o</h2>
        </div>

        <div class="painel-admin-body">
            <p><strong>Total Check-outs:</strong> <span id="totalCheckouts">0</span></p>
            <p><strong>Total Base:</strong> ‚Ç¨<span id="totalBase">0.00</span></p>
            <p><strong>Total Extras:</strong> ‚Ç¨<span id="totalExtras">0.00</span></p>
            <p><strong>Total Geral:</strong> ‚Ç¨<span id="totalGeral">0.00</span></p>
            <p><strong>Pagamento Previsto:</strong> <span id="dataPagamento">‚Äî</span></p>
        </div>
    </section>

    <!-- LISTA -->
    <section class="secao">
        <h2>Lista de Limpeza</h2>
        <button class="btn-primario" onclick="exportarExcel()">Exportar Excel</button>
        <button class="btn-primario" onclick="exportarPDF()">Exportar PDF</button>
        <button class="btn-primario" onclick="exportarEEnviarWhatsApp()">
        Exportar PDF e Enviar WhatsApp
        </button>

        <table id="tabelaLimpeza" class="tabela">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Apt</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>H√≥sp.</th>
                    <th>Ad.</th>
                    <th>Cr.</th>
                    <th>Idades</th>
                    <th>Ber√ßo</th>
                    <th>Coment√°rios</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- CALEND√ÅRIO -->
    <section class="secao">
        <h2>Calend√°rio</h2>
        <div id="calendarioContainer"></div>
    </section>

   <!-- JS -->
<script src="js/reservas-core.js"></script>
<script src="js/limpeza.js"></script>

<!-- Bibliotecas para exporta√ß√£o -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
window.addEventListener("load", function () {

    // EXPORTAR EXCEL
  window.exportarExcel = function () {
    const tabela = document.querySelector("#tabelaLimpeza");

    // Converter tabela em sheet
    const ws = XLSX.utils.table_to_sheet(tabela);

    // Detectar intervalo
    const range = XLSX.utils.decode_range(ws['!ref']);

    // Aplicar largura autom√°tica
    const colWidths = [];
    for (let C = range.s.c; C <= range.e.c; ++C) {
        let maxWidth = 10;
        for (let R = range.s.r; R <= range.e.r; ++R) {
            const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
            if (cell && cell.v) {
                const len = cell.v.toString().length;
                if (len > maxWidth) maxWidth = len;
            }
        }
        colWidths.push({ wch: maxWidth + 2 });
    }
    ws['!cols'] = colWidths;

    // Estilo do cabe√ßalho
    for (let C = range.s.c; C <= range.e.c; ++C) {
        const cellRef = XLSX.utils.encode_cell({ r: 0, c: C });
        if (ws[cellRef]) {
            ws[cellRef].s = {
                fill: { fgColor: { rgb: "D9E1F2" } },
                font: { bold: true },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    top: { style: "thin", color: { rgb: "000000" } },
                    bottom: { style: "thin", color: { rgb: "000000" } },
                    left: { style: "thin", color: { rgb: "000000" } },
                    right: { style: "thin", color: { rgb: "000000" } }
                }
            };
        }
    }

    // Formatar datas (colunas 2 e 3 ‚Üí Check-in e Check-out)
    const dateCols = [2, 3];
    for (let C of dateCols) {
        for (let R = 1; R <= range.e.r; ++R) {
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = ws[cellRef];
            if (cell && typeof cell.v === "string" && cell.v.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const [dia, mes, ano] = cell.v.split("/");
                const jsDate = new Date(`${ano}-${mes}-${dia}`);
                cell.v = jsDate;
                cell.t = "d";
                cell.z = "dd/mm/yyyy";
            }
        }
    }

    // Filtros autom√°ticos
    ws['!autofilter'] = { ref: XLSX.utils.encode_range(range) };

    // Congelar cabe√ßalho
    ws['!freeze'] = { xSplit: 0, ySplit: 1 };

    // Criar workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Limpeza");

    // Exportar
    XLSX.writeFile(wb, "limpeza_formatado.xlsx");
};


    // EXPORTAR PDF
    window.exportarPDF = function () {

        const secoes = document.querySelectorAll(".secao");
        console.log("Sec√ß√µes encontradas:", secoes);

        const listaSecao = secoes[0];
        const calendarioSecao = secoes[1];

        if (!listaSecao || !calendarioSecao) {
            alert("Erro ao gerar PDF: sec√ß√µes n√£o encontradas.");
            return;
        }

        const wrapper = document.createElement("div");
        wrapper.style.width = "100%";
        wrapper.style.boxSizing = "border-box";

        const listaClone = listaSecao.cloneNode(true);
        wrapper.appendChild(listaClone);

        const calendarioClone = calendarioSecao.cloneNode(true);
        calendarioClone.style.pageBreakBefore = "always";
        calendarioClone.style.width = "100%";
        calendarioClone.style.boxSizing = "border-box";
        calendarioClone.style.paddingLeft = "0";
        calendarioClone.style.marginLeft = "0";

        wrapper.appendChild(calendarioClone);

        document.body.appendChild(wrapper);

        const opt = {
    margin: [10, 5, 10, 0], // [top, right, bottom, left]
    filename: "limpeza_completa.pdf",
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "landscape" },
    pagebreak: { mode: ['css', 'legacy'] }
};


        html2pdf()
            .set(opt)
            .from(wrapper)
            .save()
            .then(() => {
                document.body.removeChild(wrapper);
            });
    };

});

    // üî• NOVA FUN√á√ÉO ‚Äî Exportar PDF e abrir o grupo WhatsApp
window.exportarEEnviarWhatsApp = function () {

    // 1) gerar o PDF
    window.exportarPDF();

    // 2) abrir o grupo WhatsApp ap√≥s 2 segundos
    setTimeout(() => {
        const grupo = "D98y5fnPZ7A7IeYZuNjlt1"; // <-- ID do teu grupo
        const link = `https://chat.whatsapp.com/${grupo}`;
        window.open(link, "_blank");
    }, 2000);
};

</script>
<script src="js/menu.js"></script>

</body>
</html>


